<script>
class ReceiverConnection {
  constructor() {
    this.socket = null;
    this.peer = null;
    this.localStream = null;
    this.remoteStream = null;
    this.myId = null;
    this.token = null;
    this.isConnected = false;
    
    this.initialize();
  }

  async initialize() {
    try {
      console.log('üöÄ Iniciando receiver...');
      
      // 1. EXTRAIR TOKEN DA URL
      const urlParams = new URLSearchParams(window.location.search);
      this.token = urlParams.get('token');
      
      console.log('üìã Token da URL:', this.token);
      
      if (!this.token) {
        throw new Error('Token n√£o encontrado na URL');
      }
      
      // 2. GERAR ID FIXO
      this.myId = this.token.slice(-8);
      console.log('üÜî ID gerado:', this.myId);
      
      // 3. ATUALIZAR UI
      document.getElementById('idDisplay').textContent = `ID: ${this.myId}`;
      document.getElementById('status').textContent = 'üü° Conectando...';
      
      // 4. CONECTAR AO SERVIDOR
      this.connectToSignalingServer();
      
      // 5. C√ÇMERA
      this.localStream = await navigator.mediaDevices.getUserMedia({ 
        video: { width: 1280, height: 720 }, audio: false 
      });
      
      const localVideo = document.getElementById('localVideo');
      localVideo.srcObject = this.localStream;
      
      // 6. ‚úÖ TENTAR CRIAR QR CODE (M√öLTIPLAS FORMAS)
      this.tryAllQRCodeMethods();
      
      document.getElementById('status').textContent = 'üü¢ Online - Aguardando';
      
    } catch (error) {
      console.error('‚ùå Erro:', error);
      document.getElementById('status').textContent = 'üî¥ Erro: ' + error.message;
    }
  }

  tryAllQRCodeMethods() {
    console.log('üéØ Tentando criar QR Code...');
    
    const callerUrl = `https://lemur-interface-traducao.pages.dev/caller.html?id=${this.myId}&token=${this.token}`;
    console.log('üîó URL para QR:', callerUrl);
    
    // ‚úÖ M√âTODO 1: Direto com a biblioteca
    try {
      console.log('üîÑ Tentando M√©todo 1: Biblioteca direta...');
      document.getElementById('qrcode').innerHTML = '';
      new QRCode(document.getElementById('qrcode'), {
        text: callerUrl,
        width: 200,
        height: 200,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.L
      });
      this.showQRSuccess('M√©todo 1 funcionou!');
      return;
    } catch (error) {
      console.log('‚ùå M√©todo 1 falhou:', error);
    }
    
    // ‚úÖ M√âTODO 2: URL mais curta (sem token)
    try {
      console.log('üîÑ Tentando M√©todo 2: URL sem token...');
      document.getElementById('qrcode').innerHTML = '';
      const shortUrl = `https://lemur-interface-traducao.pages.dev/caller.html?id=${this.myId}`;
      new QRCode(document.getElementById('qrcode'), {
        text: shortUrl,
        width: 200,
        height: 200,
        colorDark: "#000000",
        colorLight: "#ffffff"
      });
      this.showQRSuccess('M√©todo 2 funcionou (sem token)');
      return;
    } catch (error) {
      console.log('‚ùå M√©todo 2 falhou:', error);
    }
    
    // ‚úÖ M√âTODO 3: Apenas texto com ID
    try {
      console.log('üîÑ Tentando M√©todo 3: Apenas ID...');
      document.getElementById('qrcode').innerHTML = '';
      new QRCode(document.getElementById('qrcode'), {
        text: this.myId, // Apenas o ID
        width: 200,
        height: 200,
        colorDark: "#000000",
        colorLight: "#ffffff"
      });
      this.showQRSuccess('M√©todo 3 funcionou (apenas ID)');
      return;
    } catch (error) {
      console.log('‚ùå M√©todo 3 falhou:', error);
    }
    
    // ‚ùå SE TODOS FALHAREM
    console.error('‚ùå Todos os m√©todos de QR Code falharam!');
    document.getElementById('qrInstructions').innerHTML = 
      `ID: <strong>${this.myId}</strong><br>‚ùå Erro ao gerar QR Code`;
    document.getElementById('qrContainer').classList.remove('hidden');
  }

  showQRSuccess(method) {
    console.log('‚úÖ QR Code criado:', method);
    document.getElementById('qrInstructions').innerHTML = 
      `ID: <strong>${this.myId}</strong><br>Escaneie para conectar`;
    document.getElementById('qrContainer').classList.remove('hidden');
  }

  connectToSignalingServer() {
    console.log('üì° Conectando ao servidor...');
    this.socket = io('https://lemur-signal.onrender.com');
    
    this.socket.on('connect', () => {
      console.log('‚úÖ Conectado ao servidor');
      this.socket.emit('register', { userId: this.myId, userType: 'receiver' });
    });

    this.socket.on('registered', (data) => {
      console.log('‚úÖ Registrado:', data);
    });

    this.socket.on('incomingCall', (data) => {
      console.log('üìû Chamada recebida:', data.from);
      this.handleIncomingCall(data);
    });
  }

  handleIncomingCall(data) {
    document.getElementById('status').textContent = 'üü° Conectando...';
    document.getElementById('qrContainer').classList.add('hidden');
    
    this.peer = new SimplePeer({
      initiator: false,
      stream: this.localStream,
      trickle: false,
      config: { iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:global.stun.twilio.com:3478' }
      ]}
    });

    this.peer.on('signal', (signalData) => {
      this.socket.emit('acceptCall', { callerId: data.from, signal: signalData });
    });

    this.peer.on('connect', () => {
      this.isConnected = true;
      document.getElementById('status').textContent = 'üü¢ Conectado!';
    });

    this.peer.on('stream', (stream) => {
      this.remoteStream = stream;
      document.getElementById('remoteVideo').srcObject = stream;
    });

    this.peer.signal(data.signal);
  }
}

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
  console.log('üìÑ DOM carregado');
  window.receiver = new ReceiverConnection();
});
</script>
